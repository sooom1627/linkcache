---
description: 
globs: **.test.*
alwaysApply: false
---
# Classical TDD テスト戦略

## 🎯 Core Philosophy: Classical Testing (Sociable Tests)

### 基本原則
**「実際の依存関係と共にテストする」**

Classical Testing（古典派TDD）では、モジュールを**実際の依存関係と共に**テストします。これは「Sociable Tests（社交的テスト）」とも呼ばれ、London School の「Solitary Tests（孤立テスト）」と対比されます。

**重要な概念：**
- **本物の関数/モジュールを使う**: 内部の依存関係はモックしない
- **外部境界のみモック**: プロセス外（DB、API、デバイス）のみモック
- **統合された動作を検証**: モジュール間の実際の協調動作をテスト

### AIへの明確な指示
```
テストを書く時のルール：
1. 内部モジュール（hooks, utils, helpers）は実際のものをimportして使う
2. Supabase、外部API、デバイスAPIのみモックする
3. テストファイルは100行以内に収める
4. 正常系の動作を中心にテストする
```

## 📊 何をテストするか / しないか

### ✅ テストを書く（WRITE TESTS）
```
以下の条件を満たすコードはテストを書く：
- ビジネスロジック（計算、変換、条件分岐）
- データ変換・フォーマット処理
- バリデーション関数
- 3回以上使われる共通関数
- 副作用を持つカスタムフック（API呼び出し、状態更新）
```

### ❌ テストを書かない（NO TESTS）
```
以下のコードはテストを書かない：
- UIコンポーネント（View, Text, TouchableOpacity等）
- スタイリングのみのコード
- 単純なgetter/setter
- 1-2箇所でしか使わないヘルパー関数
- 型定義ファイル
```

## 🔨 Classical TDD 実装ガイド

### モックの判断基準（AIが迷わないように）

```typescript
// ❌ 間違い：内部モジュールをモックしない
jest.mock('../utils/validators');  // ❌ 内部モジュール
jest.mock('../hooks/useAuth');      // ❌ 内部フック

// ✅ 正解：外部境界のみモック
jest.mock('@supabase/supabase-js'); // ✅ 外部ライブラリ
jest.mock('expo-camera');           // ✅ デバイスAPI
```

## 🏗️ テスト構造テンプレート

### AIが従うべきテスト構造

```typescript
// [機能名].test.ts - 必ず100行以内

import { renderHook, act } from '@testing-library/react-native';
// 実際のモジュールをimport（モックしない）
import { actualHelper } from './helpers';
import { actualValidator } from './validators';

// 外部境界のみモック
jest.mock('@supabase/supabase-js');

describe('[機能名]', () => {
  // セットアップは最小限（10行以内）
  beforeEach(() => {
    jest.clearAllMocks();
  });

  // 正常系を中心に3-5個のテスト
  it('should [期待される動作] when [条件]', () => {
    // Arrange: 準備
    const input = 'test';
    
    // Act: 実行
    const result = actualFunction(input);
    
    // Assert: 検証
    expect(result).toBe(expected);
  });

  // エラーケースは重要なもののみ（1-2個）
  it('should handle error when [エラー条件]', () => {
    // 重要なエラーケースのみ
  });
});
```

## 🚦 判断フローチャート（AIが判断に迷わないように）

```mermaid
テストを書くべきか判断：
├─ UIコンポーネント？ → No → テスト不要
├─ 外部ライブラリのラッパー？ → No → テスト不要  
├─ ビジネスロジックあり？ → Yes → テスト必須
├─ 3回以上使用？ → Yes → テスト必須
└─ それ以外 → No → テスト不要
```

## ⚠️ AIが陥りがちな間違いと正解

### 1. モックの間違い
```typescript
// ❌ AIがよくする間違い：何でもモックする
jest.mock('./useProfileForm');
jest.mock('./validators');
jest.mock('./formatters');

// ✅ 正解：外部境界のみ
jest.mock('@supabase/supabase-js');
// 内部モジュールは実際のものを使う
import { useProfileForm } from './useProfileForm'; // 実物
```

### 2. テスト配置
```typescript
src/__tests__/features/auth/useAuth.test.ts
```

### 3. 過度なテストケース
```typescript
// ❌ AIがよくする間違い：全パターン網羅
it('should handle empty string');
it('should handle null');
it('should handle undefined');
it('should handle special characters');
// ... 20個のエッジケース

// ✅ 正解：重要なケースのみ（3-5個）
it('should format valid input correctly');
it('should return error for invalid format');
it('should handle empty input');
```

## 📋 React Native 特有の注意点

### React Query使用時
```typescript
// 必須：クリーンアップを忘れない
afterEach(() => {
  queryClient.clear();
});
```

### カスタムフック
```typescript
// renderHookを使用
import { renderHook } from '@testing-library/react-native';
```

## 🎯 品質基準

### 良いテストの条件
1. **Fast**: 1秒以内で実行
2. **Reliable**: 常に同じ結果
3. **Simple**: 100行以内
4. **Clear**: テスト名から仕様が分かる

### カバレッジ目標
**カバレッジ率の目標は設定しない。** 重要な動作が検証されていることが大切。

## 最重要指示

```
Classical TDD のルール：
1. 内部モジュールは実物を使う（モックしない）
2. 外部境界（Supabase、API、デバイス）のみモック
3. テストファイルは対象ファイルと同じディレクトリ
4. 100行以内、3-5個のテストケース
5. UIコンポーネントはテストしない
6. 正常系を中心にテスト

これらのルールを必ず守ってテストを書くこと。
```
